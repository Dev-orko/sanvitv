<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Video Stream Diagnostics</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: #141414;
            color: #fff;
            padding: 20px;
        }
        .container { max-width: 1200px; margin: 0 auto; }
        h1 { color: #e50914; margin-bottom: 30px; }
        .section {
            background: #222;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }
        .log {
            background: #000;
            padding: 15px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
            margin-top: 10px;
            white-space: pre-wrap;
        }
        button {
            background: #e50914;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            margin: 5px;
        }
        button:hover { background: #f40612; }
        .success { color: #46d369; }
        .error { color: #e50914; }
        .warning { color: #ffa500; }
        video {
            width: 100%;
            border-radius: 8px;
            margin-top: 15px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîç Mission Impossible Stream Diagnostics</h1>
        
        <div class="section">
            <h2>Step 1: Test Proxy Connection</h2>
            <button onclick="testProxyRoot()">Test Proxy Root</button>
            <button onclick="testYearDir()">Test 2025 Directory</button>
            <button onclick="testMovieDir()">Test Movie Directory</button>
            <button onclick="testVideoFile()">Test Video File</button>
            <div id="proxy-log" class="log"></div>
        </div>

        <div class="section">
            <h2>Step 2: Simulate FTP Provider Search</h2>
            <button onclick="simulateSearch()">Run Search Simulation</button>
            <div id="search-log" class="log"></div>
        </div>

        <div class="section">
            <h2>Step 3: Direct Video Test</h2>
            <button onclick="playVideo()">Play Video</button>
            <div id="video-log" class="log"></div>
            <video id="video" controls style="display:none;"></video>
        </div>
    </div>

    <script>
        const PROXY_BASE = '/ftp/FTP-2/English%20Movies/';
        const YEAR_DIR = PROXY_BASE + '2025/';
        const MOVIE_DIR = YEAR_DIR + 'Mission-Impossible-The-Final-Reckoning-2025/';
        const VIDEO_FILE = MOVIE_DIR + 'Mission-Impossible-The-Final-Reckoning-2025-1080p-AMZN-WEB-DL-DDP5-1-Atmos-H-264-BYNDR_reencoded.mp4';

        function log(id, message, type = 'info') {
            const logDiv = document.getElementById(id);
            const time = new Date().toLocaleTimeString();
            const icon = type === 'success' ? '‚úÖ' : type === 'error' ? '‚ùå' : type === 'warning' ? '‚ö†Ô∏è' : 'üìù';
            const className = type === 'success' ? 'success' : type === 'error' ? 'error' : type === 'warning' ? 'warning' : '';
            logDiv.innerHTML += `<span class="${className}">[${time}] ${icon} ${message}</span>\n`;
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        async function testProxyRoot() {
            const logId = 'proxy-log';
            document.getElementById(logId).innerHTML = '';
            log(logId, `Testing proxy root: ${PROXY_BASE}`);
            
            try {
                const response = await fetch(PROXY_BASE);
                if (response.ok) {
                    const html = await response.text();
                    log(logId, `Root accessible! Got ${html.length} chars`, 'success');
                    
                    // Check for 2025 directory
                    if (html.includes('2025/')) {
                        log(logId, '2025/ directory found in listing!', 'success');
                    } else {
                        log(logId, '2025/ directory NOT found in listing', 'warning');
                    }
                } else {
                    log(logId, `Failed: ${response.status} ${response.statusText}`, 'error');
                }
            } catch (error) {
                log(logId, `Error: ${error.message}`, 'error');
            }
        }

        async function testYearDir() {
            const logId = 'proxy-log';
            log(logId, `Testing year directory: ${YEAR_DIR}`);
            
            try {
                const response = await fetch(YEAR_DIR);
                if (response.ok) {
                    const html = await response.text();
                    log(logId, `Year directory accessible! Got ${html.length} chars`, 'success');
                    
                    // Check for movie directory
                    if (html.includes('Mission-Impossible-The-Final-Reckoning-2025')) {
                        log(logId, 'Movie directory found in listing!', 'success');
                    } else {
                        log(logId, 'Movie directory NOT found', 'warning');
                    }
                } else {
                    log(logId, `Failed: ${response.status} ${response.statusText}`, 'error');
                }
            } catch (error) {
                log(logId, `Error: ${error.message}`, 'error');
            }
        }

        async function testMovieDir() {
            const logId = 'proxy-log';
            log(logId, `Testing movie directory: ${MOVIE_DIR}`);
            
            try {
                const response = await fetch(MOVIE_DIR);
                if (response.ok) {
                    const html = await response.text();
                    log(logId, `Movie directory accessible! Got ${html.length} chars`, 'success');
                    
                    // Check for video file
                    if (html.includes('.mp4')) {
                        log(logId, 'Video file(s) found in listing!', 'success');
                        
                        // Extract file names
                        const matches = html.match(/href="([^"]+\.mp4)"/gi);
                        if (matches) {
                            log(logId, `Found ${matches.length} MP4 file(s):`, 'success');
                            matches.forEach(m => {
                                const filename = m.match(/href="([^"]+)"/)[1];
                                log(logId, `  - ${filename}`);
                            });
                        }
                    } else {
                        log(logId, 'No .mp4 files found', 'warning');
                    }
                } else {
                    log(logId, `Failed: ${response.status} ${response.statusText}`, 'error');
                }
            } catch (error) {
                log(logId, `Error: ${error.message}`, 'error');
            }
        }

        async function testVideoFile() {
            const logId = 'proxy-log';
            log(logId, `Testing video file HEAD request...`);
            log(logId, `URL: ${VIDEO_FILE}`);
            
            try {
                const response = await fetch(VIDEO_FILE, { method: 'HEAD' });
                if (response.ok) {
                    log(logId, `Video file exists! Status: ${response.status}`, 'success');
                    log(logId, `Content-Type: ${response.headers.get('content-type')}`);
                    const size = response.headers.get('content-length');
                    if (size) {
                        const sizeMB = (parseInt(size) / 1024 / 1024).toFixed(2);
                        log(logId, `Size: ${sizeMB} MB`, 'success');
                    }
                    log(logId, `Accept-Ranges: ${response.headers.get('accept-ranges') || 'none'}`);
                } else {
                    log(logId, `Failed: ${response.status} ${response.statusText}`, 'error');
                }
            } catch (error) {
                log(logId, `Error: ${error.message}`, 'error');
            }
        }

        async function simulateSearch() {
            const logId = 'search-log';
            document.getElementById(logId).innerHTML = '';
            
            const title = 'Mission: Impossible - The Final Reckoning';
            const year = 2025;
            
            log(logId, `üé¨ Simulating search for: "${title}" (${year})`);
            
            // Tokenize
            const normalize = (s) => s.toLowerCase()
                .replace(/[_\.\-]+/g, ' ')
                .replace(/\([^\)]*\)/g, ' ')
                .replace(/\[[^\]]*\]/g, ' ')
                .replace(/[^a-z0-9\s]/g, ' ')
                .replace(/\s+/g, ' ')
                .trim();
            
            const stopWords = new Set(['the','a','an','of','in','on','at','to','for','with','by','and','or','from','into','over','your','my','is','are','be','this','that','it','as','part','chapter']);
            
            const tokenize = (s) => normalize(s).split(' ').filter(t => t.length >= 2 && !stopWords.has(t));
            
            const tokens = tokenize(title);
            log(logId, `Query tokens: [${tokens.join(', ')}]`, 'success');
            log(logId, `Year: ${year}`);
            
            // Test if we can find the directory
            log(logId, `\nStep 1: Checking for ${year}/ directory...`);
            try {
                const rootResponse = await fetch(PROXY_BASE);
                const rootHtml = await rootResponse.text();
                
                if (rootHtml.includes(`${year}/`)) {
                    log(logId, `‚úÖ Found ${year}/ directory`, 'success');
                    
                    // Check inside year directory
                    log(logId, `\nStep 2: Checking inside ${year}/ directory...`);
                    const yearResponse = await fetch(YEAR_DIR);
                    const yearHtml = await yearResponse.text();
                    
                    const movieDirPattern = /Mission-Impossible-The-Final-Reckoning/i;
                    if (movieDirPattern.test(yearHtml)) {
                        log(logId, `‚úÖ Found movie directory!`, 'success');
                        
                        // Check inside movie directory
                        log(logId, `\nStep 3: Checking for video files...`);
                        const movieResponse = await fetch(MOVIE_DIR);
                        const movieHtml = await movieResponse.text();
                        
                        const mp4Pattern = /href="([^"]+\.mp4)"/gi;
                        const mp4Files = [];
                        let match;
                        while ((match = mp4Pattern.exec(movieHtml)) !== null) {
                            mp4Files.push(match[1]);
                        }
                        
                        if (mp4Files.length > 0) {
                            log(logId, `‚úÖ Found ${mp4Files.length} video file(s):`, 'success');
                            mp4Files.forEach(file => {
                                log(logId, `  üìπ ${decodeURIComponent(file)}`);
                            });
                            
                            const fullPath = MOVIE_DIR + mp4Files[0];
                            log(logId, `\nüì∫ Final stream URL:`, 'success');
                            log(logId, fullPath, 'success');
                        } else {
                            log(logId, `‚ùå No video files found`, 'error');
                        }
                    } else {
                        log(logId, `‚ùå Movie directory not found`, 'error');
                    }
                } else {
                    log(logId, `‚ùå Year directory not found`, 'error');
                }
            } catch (error) {
                log(logId, `Error: ${error.message}`, 'error');
            }
        }

        function playVideo() {
            const logId = 'video-log';
            const video = document.getElementById('video');
            
            document.getElementById(logId).innerHTML = '';
            video.style.display = 'block';
            
            log(logId, `üì∫ Loading video from: ${VIDEO_FILE}`);
            
            video.src = VIDEO_FILE;
            
            video.addEventListener('loadstart', () => {
                log(logId, 'üì° Loading started...', 'info');
            });
            
            video.addEventListener('loadedmetadata', () => {
                log(logId, `‚úÖ Metadata loaded - Duration: ${video.duration.toFixed(2)}s`, 'success');
            });
            
            video.addEventListener('canplay', () => {
                log(logId, '‚úÖ Video ready to play!', 'success');
            });
            
            video.addEventListener('playing', () => {
                log(logId, '‚ñ∂Ô∏è Video is playing!', 'success');
            });
            
            video.addEventListener('error', (e) => {
                log(logId, `‚ùå Video error!`, 'error');
                log(logId, `Error code: ${video.error?.code}`, 'error');
                log(logId, `Error message: ${video.error?.message}`, 'error');
                log(logId, `Network state: ${video.networkState}`, 'error');
                log(logId, `Ready state: ${video.readyState}`, 'error');
            });
            
            video.play().catch(err => {
                log(logId, `‚ö†Ô∏è Autoplay failed: ${err.message}`, 'warning');
            });
        }

        // Auto-run basic tests on load
        window.addEventListener('load', () => {
            console.log('Diagnostics page loaded');
            console.log('Test URLs:', { PROXY_BASE, YEAR_DIR, MOVIE_DIR, VIDEO_FILE });
        });
    </script>
</body>
</html>
